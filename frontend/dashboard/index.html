<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .dashboard-header { background-color: #fff; padding: 1rem; border-bottom: 1px solid #dee2e6; }
        .dashboard-header h4 { margin-bottom: 0; }
        .welcome-message { font-size: 1.1rem; }
        .role-badge { font-size: 0.9rem; }
        .card { margin-top: 1.5rem; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="dashboard-header d-flex justify-content-between align-items-center mt-3">
            <div>
                <h4>Dashboard</h4>
                <span class="welcome-message">Welcome, {{ username }}!</span>
            </div>
            <div>
                 <span class="badge rounded-pill text-bg-primary role-badge">{{ role }}</span>
                 <button class="btn btn-sm btn-outline-secondary ms-2" @click="logout">Logout</button>
            </div>
        </div>

        <!-- Customer Panel -->
        <div v-if="role === 'customer'" class="card">
            <div class="card-header">Customer Actions</div>
            <div class="card-body">
                <h5 class="card-title">My Reviews</h5>
                <p class="card-text">Here you can create new reviews and see your past reviews.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createReviewModal">Create a New Review</button>
                <button class="btn btn-info ms-2" @click="fetchMyReviews" :disabled="isLoadingReviews">
                    <span v-if="isLoadingReviews" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    {{ isLoadingReviews ? 'Loading...' : 'View My Reviews' }}
                </button>
            </div>
            <!-- My Reviews List -->
            <div v-if="reviewsError" class="alert alert-danger m-3">{{ reviewsError }}</div>
            <div v-if="myReviews.length > 0" class="card-body border-top">
                <h6>Your Submitted Reviews</h6>
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">#ID</th>
                            <th scope="col">Store ID</th>
                            <th scope="col">Score</th>
                            <th scope="col">Content</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="review in myReviews" :key="review.reviewID">
                            <th scope="row">{{ review.reviewID }}</th>
                            <td>{{ review.storeID }}</td>
                            <td>{{ review.score }}</td>
                            <td>{{ review.content.substring(0, 50) }}...</td>
                            <td><span class="badge" :class="getReviewStatusClass(review.status)">{{ getReviewStatusText(review.status) }}</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Merchant Panel -->
        <div v-if="role === 'merchant'" class="card">
            <div class="card-header">Merchant Actions</div>
            <div class="card-body">
                <h5 class="card-title">Manage Store Reviews</h5>
                <p class="card-text">View and reply to reviews for your store, or appeal a review.</p>
                <button class="btn btn-primary" @click="fetchStoreReviews" :disabled="isLoadingStoreReviews">
                    <span v-if="isLoadingStoreReviews" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    {{ isLoadingStoreReviews ? 'Loading...' : 'View Store Reviews' }}
                </button>
                 <p class="mt-3">Have an issue with a review? Enter the Review ID to manage.</p>
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Enter Review ID" v-model="managedReviewId">
                    <button class="btn btn-success" @click="openReplyModal" :disabled="!managedReviewId">Reply</button>
                    <button class="btn btn-warning" @click="openAppealModal" :disabled="!managedReviewId">Appeal</button>
                </div>
            </div>
            <!-- Store Reviews List -->
            <div v-if="storeReviewsError" class="alert alert-danger m-3">{{ storeReviewsError }}</div>
            <div v-if="storeReviews.length > 0" class="card-body border-top">
                <h6>Reviews for Your Store</h6>
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">Review ID</th>
                            <th scope="col">User ID</th>
                            <th scope="col">Score</th>
                            <th scope="col">Content</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="review in storeReviews" :key="review.reviewID" @click="manageReview(review.reviewID, review.storeID)" style="cursor: pointer;">
                            <th scope="row">{{ review.reviewID }}</th>
                            <td>{{ review.userID }}</td>
                            <td>{{ review.score }}</td>
                            <td>{{ review.content.substring(0, 50) }}...</td>
                            <td><span class="badge" :class="getReviewStatusClass(review.status)">{{ getReviewStatusText(review.status) }}</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reviewer Panel -->
        <div v-if="role === 'reviewer'" class="card">
            <div class="card-header">Reviewer Actions</div>
            <div class="card-body">
                <h5 class="card-title">Audit Center</h5>
                <p class="card-text">Audit pending reviews and appeals.</p>
                 <div class="input-group">
                    <input type="text" class="form-control" placeholder="Enter Review or Appeal ID">
                    <button class="btn btn-success">Approve</button>
                    <button class="btn btn-danger">Reject</button>
                </div>
            </div>
        </div>

        <!-- Create Review Modal -->
        <div class="modal fade" id="createReviewModal" tabindex="-1" aria-labelledby="createReviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createReviewModalLabel">Create a New Review</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="submitReview">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="orderId" class="form-label">Order ID</label>
                                    <input type="number" class="form-control" id="orderId" v-model.number="reviewForm.orderID" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="storeId" class="form-label">Store ID</label>
                                    <input type="number" class="form-control" id="storeId" v-model.number="reviewForm.storeID" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="score" class="form-label">Overall Score (1-5)</label>
                                    <input type="number" class="form-control" id="score" v-model.number="reviewForm.score" min="1" max="5" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="serviceScore" class="form-label">Service Score (1-5)</label>
                                    <input type="number" class="form-control" id="serviceScore" v-model.number="reviewForm.serviceScore" min="1" max="5" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="expressScore" class="form-label">Express Score (1-5)</label>
                                    <input type="number" class="form-control" id="expressScore" v-model.number="reviewForm.expressScore" min="1" max="5" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="content" class="form-label">Review Content</label>
                                <textarea class="form-control" id="content" rows="4" v-model="reviewForm.content" required></textarea>
                            </div>
                             <div class="mb-3">
                                <label for="picInfo" class="form-label">Image URLs (comma-separated)</label>
                                <input type="text" class="form-control" id="picInfo" v-model="reviewForm.picInfo">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="anonymous" v-model="reviewForm.anonymous">
                                <label class="form-check-label" for="anonymous">
                                    Submit Anonymously
                                </label>
                            </div>
                            <div class="alert" v-if="reviewMessage" :class="isReviewError ? 'alert-danger' : 'alert-success'">
                                {{ reviewMessage }}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Submit Review</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reply Modal -->
        <div class="modal fade" id="replyModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Reply to Review #{{ managedReviewId }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="submitReply">
                            <div class="mb-3">
                                <label for="replyContent" class="form-label">Your Reply</label>
                                <textarea class="form-control" id="replyContent" rows="4" v-model="replyForm.content" required></textarea>
                            </div>
                             <div class="alert" v-if="actionMessage" :class="isActionError ? 'alert-danger' : 'alert-success'">{{ actionMessage }}</div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Submit Reply</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appeal Modal -->
        <div class="modal fade" id="appealModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Appeal Review #{{ managedReviewId }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="submitAppeal">
                            <div class="mb-3">
                                <label for="appealReason" class="form-label">Reason for Appeal</label>
                                <input type="text" class="form-control" id="appealReason" v-model="appealForm.reason" required>
                            </div>
                            <div class="mb-3">
                                <label for="appealContent" class="form-label">Detailed Explanation</label>
                                <textarea class="form-control" id="appealContent" rows="4" v-model="appealForm.content" required></textarea>
                            </div>
                            <div class="alert" v-if="actionMessage" :class="isActionError ? 'alert-danger' : 'alert-success'">{{ actionMessage }}</div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-warning">Submit Appeal</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    username: '',
                    role: '',
                    userId: null,
                    storeId: null, // Add storeId to data
                    // Customer data
                    myReviews: [],
                    isLoadingReviews: false,
                    reviewsError: '',
                    // Merchant data
                    storeReviews: [],
                    isLoadingStoreReviews: false,
                    storeReviewsError: '',
                    managedReviewId: '',
                    replyForm: { content: '' },
                    appealForm: { reason: '', content: '' },
                    actionMessage: '',
                    isActionError: false,
                    replyModalInstance: null,
                    appealModalInstance: null,
                    reviewForm: {
                        orderID: null,
                        storeID: null,
                        score: 5,
                        serviceScore: 5,
                        expressScore: 5,
                        content: '',
                        picInfo: '',
                        videoInfo: '', // video not implemented in this form
                        anonymous: false
                    },
                    reviewMessage: '',
                    isReviewError: false,
                }
            },
            created() {
                this.loadUserData();
            },
            mounted() {
                this.replyModalInstance = new bootstrap.Modal(document.getElementById('replyModal'));
                this.appealModalInstance = new bootstrap.Modal(document.getElementById('appealModal'));
            },
            methods: {
                loadUserData() {
                    const token = localStorage.getItem('jwt_token');
                    if (!token) {
                        // If no token, redirect to login page
                        window.location.href = '/user/index.html';
                        return;
                    }
                    try {
                        const decodedToken = jwt_decode(token);
                        this.username = decodedToken.username || 'User'; // assuming username is in token
                        this.role = decodedToken.role;
                        this.userId = decodedToken.user_id;
                        this.storeId = decodedToken.store_id || null; // Decode store_id

                        // Set Axios default header for subsequent requests
                        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

                    } catch (error) {
                        console.error("Failed to decode token:", error);
                        this.logout();
                    }
                },
                logout() {
                    localStorage.removeItem('jwt_token');
                    window.location.href = '/user/index.html';
                },
                openReplyModal() {
                    this.actionMessage = '';
                    this.isActionError = false;
                    this.replyModalInstance.show();
                },
                openAppealModal() {
                    this.actionMessage = '';
                    this.isActionError = false;
                    this.appealModalInstance.show();
                },
                async submitReply() {
                    this.actionMessage = '';
                    try {
                        const payload = {
                            reviewID: this.managedReviewId,
                            storeID: this.storeId,
                            content: this.replyForm.content,
                        };
                        console.log('Submitting reply with payload:', payload);
                        console.log('reply payload:', JSON.stringify(payload, null, 2));
                         debugger;
                         const response = await axios.post('/v1/review/reply', payload);
                        this.actionMessage = 'Reply submitted successfully! Reply ID: ' + response.data.replyID;
                        this.isActionError = false;
                        setTimeout(() => this.replyModalInstance.hide(), 2000);
                    } catch (error) {
                        this.actionMessage = error.response?.data?.message || 'Failed to submit reply.';
                        this.isActionError = true;
                    }
                },
                manageReview(reviewId, storeId) {
                    this.managedReviewId = reviewId;
                    this.storeId = storeId; // Save the specific storeId for this review
                },
                async submitAppeal() {
                    this.actionMessage = '';
                    try {
                        const payload = {
                            reviewID: this.managedReviewId,
                            storeID: this.storeId,
                            reason: this.appealForm.reason,
                            content: this.appealForm.content,
                        };
                        console.log('Submitting appeal with payload:', payload);
                        console.log('appeal payload:', JSON.stringify(payload, null, 2));
                         debugger;
                         const response = await axios.post('/v1/review/appeal', payload);
                        this.actionMessage = 'Appeal submitted successfully! Appeal ID: ' + response.data.appealID;
                        this.isActionError = false;
                        setTimeout(() => this.appealModalInstance.hide(), 2000);
                    } catch (error) {
                        this.actionMessage = error.response?.data?.message || 'Failed to submit appeal.';
                        this.isActionError = true;
                    }
                },
                async fetchStoreReviews() {
                    if (!this.storeId) {
                        this.storeReviewsError = "Could not find your Store ID. Please re-login.";
                        return;
                    }
                    this.isLoadingStoreReviews = true;
                    this.storeReviewsError = '';
                    this.storeReviews = [];
                    try {
                        const response = await axios.get(`/v1/review/store/${this.storeId}?page=1&size=20`);
                        this.storeReviews = response.data.list || [];
                        if (this.storeReviews.length === 0) {
                            this.storeReviewsError = "No reviews found for this store.";
                        }
                    } catch (error) {
                        this.storeReviewsError = error.response?.data?.message || 'Failed to fetch store reviews.';
                    } finally {
                        this.isLoadingStoreReviews = false;
                    }
                },
                async fetchMyReviews() {
                    this.isLoadingReviews = true;
                    this.reviewsError = '';
                    this.myReviews = []; // Clear previous results
                    try {
                        // For simplicity, we fetch page 1 with 20 items. Pagination can be added later.
                        const response = await axios.get(`/v1/review/user/${this.userId}?page=1&size=20`);
                        this.myReviews = response.data.list || [];
                        if (this.myReviews.length === 0) {
                            this.reviewsError = "You haven't submitted any reviews yet.";
                        }
                    } catch (error) {
                        this.reviewsError = error.response?.data?.message || 'Failed to fetch reviews.';
                    } finally {
                        this.isLoadingReviews = false;
                    }
                },
                getReviewStatusText(status) {
                    const statusMap = {
                        10: 'Pending',
                        20: 'Published',
                        30: 'Rejected',
                        40: 'Appeal Approved'
                    };
                    return statusMap[status] || 'Unknown';
                },
                getReviewStatusClass(status) {
                    const classMap = {
                        10: 'text-bg-warning', // Pending
                        20: 'text-bg-success', // Published
                        30: 'text-bg-danger',  // Rejected
                        40: 'text-bg-info'     // Appeal Approved
                    };
                    return classMap[status] || 'text-bg-secondary';
                },
                async submitReview() {
                    this.reviewMessage = '';
                    try {
                        const payload = {
                            ...this.reviewForm,
                            userID: this.userId
                        };
                        const response = await axios.post('/v1/review', payload);
                        this.reviewMessage = 'Review submitted successfully! Review ID: ' + response.data.reviewInfo.reviewID;
                        this.isReviewError = false;
                        // Optionally close modal after a short delay
                        setTimeout(() => {
                           // This requires getting the modal instance, which can be complex.
                           // For now, user can close manually. Or we can reset form.
                           this.resetReviewForm();
                        }, 2000);
                    } catch (error) {
                        this.reviewMessage = error.response?.data?.message || 'Failed to submit review.';
                        this.isReviewError = true;
                    }
                },
                resetReviewForm() {
                    this.reviewForm = {
                        orderID: null,
                        storeID: null,
                        score: 5,
                        serviceScore: 5,
                        expressScore: 5,
                        content: '',
                        picInfo: '',
                        videoInfo: '',
                        anonymous: false
                    };
                }
            }
        }).mount('#app')
    </script>
</body>
</html>